---
apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration 
metadata:
  name: {{ template "helper.fullname" . }}
  labels:
{{- include "helper.labels" . | indent 4 }}
webhooks:
- name: {{ template "helper.webhook-server-name" . }}
  sideEffects: None
  admissionReviewVersions: ["v1beta1"]
  clientConfig: 
    service:
      namespace: {{ .Release.Namespace }}
      name: {{ .Values.service.name }}
      path: '/{{ default "mutate" .Values.basePathOverride }}/{{ default "pod-nodes-selector" .Values.podNodesSelectorPathOverride }}' 
    caBundle: '{{ .Files.Get "ssl/ca.crt" | b64enc }}'
  rules: 
  - operations: 
    - CREATE
    apiGroups:
    - ""
    apiVersions:
    - "*"
    resources:
    - pods
  namespaceSelector:
    matchExpressions:
      - key: kubernetes.io/metadata.name
        operator: NotIn
        values: '{{.Values.ignoreNamespaces}}'